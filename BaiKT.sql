create table TT_H_NHAXUATBAN
(
	ID NUMBER(4,0) CONSTRAINT PK_TT_H_NHAXUATBAN PRIMARY KEY,
	MA VARCHAR2(20) , 
	TEN VARCHAR2(10) ,
	TRANGTHAI NUMBER(1), 
	DIACHI VARCHAR2(30), 
	MOTA VARCHAR2(50),
	CONSTRAINT UNQ_MA_NHAXUATBAN UNIQUE(MA)
)

create table TT_H_TACGIA
(
	ID NUMBER(4,0) CONSTRAINT PK_TT_H_TACGIA PRIMARY KEY,
	MA VARCHAR2(20) , 
	TEN VARCHAR2(10)  ,
	SDT VARCHAR2(15), 
	DIACHI VARCHAR2(30), 
	MOTA VARCHAR2(50),
	CONSTRAINT UNQ_MA_TT_H_TACGIA UNIQUE(MA)
)

create table TT_H_SACH
(
	ID NUMBER(4,0) CONSTRAINT PK_TT_H_SACH PRIMARY KEY,
	MA VARCHAR2(20) , 
	TEN VARCHAR2(10),
	IDNXB NUMBER(4,0),
	IDTG NUMBER(4,0), 
	CHUDE VARCHAR2(30), 
	NAMXB DATE,
	MOTA VARCHAR2(50),
	SLCONLAI NUMBER(3,0),
	SLDANGMUON NUMBER(3,0),
	TONGSACH NUMBER(4,0),
	CONSTRAINT UNQ_MA_TT_H_SACH UNIQUE(MA),
	CONSTRAINT FK_TT_H_SACH_IDNXB FOREIGN KEY (IDNXB) REFERENCES TT_H_NHAXUATBAN(ID),
	CONSTRAINT FK_TT_H_SACH_IDTG FOREIGN KEY (IDTG) REFERENCES TT_H_TACGIA(ID)
)

create table TT_H_BANDOC
(
	ID NUMBER(4,0) CONSTRAINT PK_TT_H_BANDOC PRIMARY KEY,
	MA VARCHAR2(20) , 
	TEN VARCHAR2(10)  ,
	SDT VARCHAR2(15), 
	DIACHI VARCHAR2(30), 
	NGAYSINH DATE,
	NGAYTAOTAIKHOAN DATE,
	HANG VARCHAR2(6),
	CONSTRAINT UNQ_MA_TT_H_BANDOC UNIQUE(MA)
)

create table TT_H_MUONSACH
(
	ID NUMBER(4,0) CONSTRAINT PK_TT_H_MUONSACH PRIMARY KEY,
	IDBANDOC NUMBER(4,0),
	IDSACH NUMBER(4,0),
	SOLUONG NUMBER(4,0),
	NGAYGIOMUON DATE, 
	NGAYGIOTRA DATE, 
	TRANGTHAI NUMBER(1),
	GHICHU VARCHAR2(30),
	CONSTRAINT FK_TT_H_MUONSACH_IDBANDOC FOREIGN KEY (IDBANDOC) REFERENCES TT_H_BANDOC(ID),
	CONSTRAINT FK_TT_H_SACH_IDSACH FOREIGN KEY (IDSACH) REFERENCES TT_H_SACH(ID)
)

--1.	Viết script tạo cấu trúc các bảng. Đối với bảng Mượn Sách cần đánh partition trên trường ngày giờ mượn, và 2 local index: 1 index trên trường id bạn đọc, 1 index trên id sách. Tên indexes theo cấu trúc : TENBANG_IDX_TENTRUONG
PARTITION BY  RANGE(NGAYGIOMUON)
(
 	PARTITION NGAYGIOMUON_2020 VALUES LESS THAN(TO_DATE('10/09/2021','DD/MM/YYYY')),
    PARTITION NGAYGIOMUON_2021 VALUES LESS THAN(TO_DATE('10/09/2022','DD/MM/YYYY')),
    PARTITION NGAYGIOMUON_2022 VALUES LESS THAN(TO_DATE('10/09/2023','DD/MM/YYYY')))
)

CREATE INDEX IND_IDBANDOC
on all_fact (ID)
LOCAL
(PARTITION 1),
(PARTITION 2),
(PARTITION 3);
CREATE INDEX IND_IDSACH
on all_fact (ID)
LOCAL
(PARTITION 1),
(PARTITION 2),
(PARTITION 3);

--2.	Viết script tạo sequence cho mỗi bảng. Sequence được dùng để insert trường Id cho các bảng. Tên sequence theo cấu trúc : TENBANG_SEQ
CREATE SEQUENCE TT_H_NHAXUATBAN_SEQ
INCREMENT 1
STRAT WITH 1	 
MAXVALUE 1000 
NO CYCLE;
CREATE SEQUENCE TT_H_TACGIA_SEQ
INCREMENT 1
STRAT WITH 1	 
MAXVALUE 1000 
NO CYCLE;
CREATE SEQUENCE TT_H_SACH_SEQ
INCREMENT 1
STRAT WITH 1	 
MAXVALUE 1000 
NO CYCLE;CREATE SEQUENCE TT_H_BANDOC_SEQ
INCREMENT 1
STRAT WITH 1	 
MAXVALUE 1000 
NO CYCLE;
NO CYCLE;CREATE SEQUENCE TT_H_MUONSACH_SEQ
INCREMENT 1
STRAT WITH 1	 
MAXVALUE 1000 
NO CYCLE;
--3.	Viết script tạo unique index cho các bảng nếu có.

--4.	Viết script insert dữ liệu mẫu cho tất cả các bảng.
INSERT INTO TT_H_NHAXUATBAN VALUES ('1','NXB1','GIAO DUC','1','HA NOI','NULL')
INSERT INTO TT_H_NHAXUATBAN VALUES ('2','NXB2','KIM DONG','1','HA NOI','NULL')
INSERT INTO TT_H_NHAXUATBAN VALUES ('3','NXB3','VAN HOC','0','HA NAM','NULL')
--
INSERT INTO TT_H_TACGIA VALUES ('1','TG1','NGOC ANH','098623464','HA NOI','NULL')
INSERT INTO TT_H_TACGIA VALUES ('2','TG2','KIM DONG','09899964','HA NAM','NULL')
INSERT INTO TT_H_TACGIA VALUES ('3','TG3','PHUONG NAM','098623464','HAI PHONG','NULL')
--
INSERT INTO TT_H_SACH VALUES ('1','S1','THO VAN','1','1','NULL','10/MAY/2016','NULL','10','23','33')
INSERT INTO TT_H_SACH VALUES ('2','S2','mMI THUAT','2','1','NULL','10/MAY/2016','NULL','11','30','40')
INSERT INTO TT_H_SACH VALUES ('3','S3','mMI THUAT','2','3','NULL','15/MAY/2016','NULL','13','20','20')
--
INSERT INTO TT_H_BANDOC VALUES ('1','BD1','HAI','092349324','HA NOI','09/MAY/2002','10/MAY/2022','BAC')
INSERT INTO TT_H_BANDOC VALUES ('2','BD2','LAN','092349324','HA NOI','09/MAY/2002','10/MAY/2022','BAC')
INSERT INTO TT_H_BANDOC VALUES ('4','BD4','lOAN','092349324','HA NOI','09/MAY/2007','10/MAY/2022','BAC')
--
INSERT INTO TT_H_MUONSACH VALUES ('1','1','2','10','09/MAY/2022','10/MAY/2022','1','NULL')
INSERT INTO TT_H_MUONSACH VALUES ('2','2','2','10','15/MAY/2022','17/MAY/2022','0','NULL')
INSERT INTO TT_H_MUONSACH VALUES ('5','1','3','20','18/AUGUST/2022','09/MAY/2022','1','NULL')
--5.	Hiển thị dách sách tác giả và tổng số lượng sách của tác giả gồm các trường thông tin:
--Mã Tác Giả, Tên Tác Giả, Chủ Đề, Số Lượng Sách
--Sắp xếp theo số lượng sách giảm dần.
SELECT T.MA,T.TEN, CHUDE, TONGSACH
FROM TT_H_TACGIA T INNER JOIN TT_H_SACH S ON T.ID = S.IDTG
ORDER BY TONGSACH DESC

--6.	Hiển thị 10 quyển sách có số lượng được mượn nhiều nhất gồm các trường thông tin:
--Mã Sách, Tên Sách, Tên Nhà Xuất Bản, Tên Tác Giả, Chủ Đề, Năm Xuất Bản, Số Lượng Còn Lại, Số Lượng Đã Mượn, Tổng Số
SELECT* FROM(SELECT  S.MA,S.TEN AS TENSACH,T.TEN AS TENNXB , S.CHUDE, S.NAMXB , S.SLCONLAI,maX(S.SLDANGMUON) AS MAXSL,S.TONGSACH 
FROM ((TT_H_SACH S
INNER JOIN TT_H_NHAXUATBAN N ON S.IDNXB = N.ID)
INNER JOIN TT_H_TACGIA T ON S.IDTG = T.ID)
GROUP BY S.TEN ,T.TEN, S.CHUDE,S.NAMXB,S.TONGSACH,S.SLCONLAI
order  by SLDANGMUON desc )
where rownum <11;
--7.	Hiển thị  thông tin bạn đọc và sách được mượn từ ngày đầu tháng hiện tại đến thời điểm hiện tại.
--Mã Bạn Đọc, Tên Bạn Đọc, Mã Sách, Tên Sách, Ngày Giờ Mượn, Số lượng
--Sắp xếp theo ngày giờ mượn giảm dần, Tên bạn đọc tăng dần.
SELECT  B.MA,B.TEN AS TENBANDOC,S.MA AS MASACH, S.TEN AS TENSACH, to_char(NGAYGIOMUON,'DD-MM-YYYY') AS NGAYMUONSACH ,TONGSACH
FROM ((TT_H_MUONSACH MS
INNER JOIN TT_H_BANDOC B ON MS.IDBANDOC = B.ID)
INNER JOIN TT_H_SACH S ON S.ID = MS.IDSACH)
WHERE NGAYGIOMUON > '01-AUGUST-2022' AND NGAYGIOMUON < SYSDATE
order  by NGAYGIOMUON desc , B.TEN ASC

--8.	Hiển thị 10 quyển sách có số lượng được mượn nhiều nhất tính từ đầu năm 2022
--Mã Sách, Tên Sách, Số Lượng Đã Được Mượn.
sELECT * FROM(SELECT  S.MA, S.TEN, MAX(SLDANGMUON) AS MAXSL
FROM TT_H_SACH S INNER JOIN TT_H_MUONSACH MS ON S.ID = MS.IDSACH
WHERE NGAYGIOMUON >'01-JANUARY-2022'
GROUP BY S.MA, S.TEN)
where rownum <11;
--9.	Hiển thị danh sách bạn đọc và số lần mượn sách tính từ đầu năm 2022 sắp xếp theo tên bạn đọc tăng dần:
--Mã Bạn Đọc, Tên Bạn Đọc, Số Lần Mượn
SELECT  B.MA, B.TEN, MS.IDBANDOC, COUNT(B.MA) AS SOLUONG
FROM TT_H_BANDOC B INNER JOIN TT_H_MUONSACH MS ON B.ID = MS.IDBANDOC
WHERE NGAYGIOMUON >'01-JANUARY-2022'
GROUP BY B.MA, B.TEN, MS.IDBANDOC
ORDER BY B.TEN ASC
--10.	Hiển thị thông tin bạn đọc gồm có:
--Mã Bạn Đọc, Tên Bạn Đọc, Tuổi (được tính dựa vào trường ngày sinh)
SELECT MA, TEN , (to_char(SYSDATE,'YYYY')-to_char(NGAYSINH,'YYYY')) AS TUOI
FROM TT_H_BANDOC


--11.	Thống kê tổng số bạn đọc theo độ tuổi
--Tuổi, Tổng số Bạn Đọc
SELECT  (to_char(SYSDATE,'YYYY')-to_char(NGAYSINH,'YYYY')) AS TUOI, COUNT(MA)
FROM TT_H_BANDOC
GROUP BY (to_char(SYSDATE,'YYYY')-to_char(NGAYSINH,'YYYY'))

--12.	Thống kê số lượng sách được xuất bản theo Nhà Xuất Bản, Theo năm xuất bản.

--Năm Xuất Bản, Mã Nhà Xuất Bản,Tên Nhà Xuất Bản, Số Lượng Sách
--Sắp xếp theo Năm xuất bản giảm dần, Tên Nhà xuất bản tăng dần.
SELECT N.MA, S.NAMXB , N.TEN, SUM(TONGSACH) AS TONGSO
FROM TT_H_NHAXUATBAN N INNER JOIN TT_H_SACH S ON N.ID = S.IDNXB
GROUP BY N.MA, S.NAMXB , N.TEN
ORDER BY NAMXB DESC,  N.TEN ASC

--13.	Hiển thị 5 quyển sách được các bạn đọc có độ tuổi từ 18 đến 25 mượn nhiều nhất tính từ đầu năm 2022. (Tính theo trường số lượng mượn của sách)
--Mã Sách, Tên Sách, Số Lượng Được Mượn
SELECT*FROM(SELECT DISTINCT S.MA, S.TEN , SLDANGMUON 
FROM ((TT_H_MUONSACH MS
INNER JOIN TT_H_BANDOC B ON MS.IDBANDOC = B.ID)
INNER JOIN TT_H_SACH S ON S.ID = MS.IDSACH)
WHERE (to_char(SYSDATE,'YYYY')-to_char(NGAYSINH,'YYYY'))>18 AND (to_char(SYSDATE,'YYYY')-to_char(NGAYSINH,'YYYY'))<25 AND NGAYGIOMUON >'01-JANUARY-2022')
where rownum <6

--14.	Hiển thị toàn bộ bạn đọc và sách mà bạn đọc đấy mượn, sẽ có bạn chưa mượn vẫn cần hiển thị và tên sách để là null.
--Mã bạn đọc, tên ban đọc, tên sách
SELECT DISTINCT B.MA AS MABANDOC, B.TEN AS TENBANDOC , S.TEN AS TENSACH
FROM ((TT_H_MUONSACH MS
RIGHT OUTER JOIN TT_H_BANDOC B ON MS.IDBANDOC = B.ID)
LEFT JOIN TT_H_SACH S ON S.ID = MS.IDSACH)
ORDER BY B.MA
